<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.ourhouse.mapper.HouseMapper">

	<!-- dealLike를 출력하기 위한 임시 resultMap -->
	<resultMap type="dealDto" id="likeDto">
		<result column="deal_code" property="dealCode" jdbcType="VARCHAR" />
		<result column="apt_code" property="price" jdbcType="VARCHAR" />
	</resultMap>
	
	<!-- column과 변수명 맞추기 위한 resultMap -->
	<resultMap type="houseDatabaseDto" id="houseDBDto">
		<result column="apt_code" property="aptCode" />
		<result column="deal_code" property="dealCode" />
		<result column="price" property="price" />
		<result column="year" property="year" />
		<result column="month" property="month" />
		<result column="area" property="area" />
		<result column="floor" property="floor" />
		<result column="build_year" property="buildYear" />
		<result column="name" property="name" />
		<result column="jibun_address" property="jibunAddress" />
		<result column="road_address" property="roadAddress" />
		<result column="lng" property="lng" />
		<result column="lat" property="lat" />
		<result column="dong_code" property="dongCode" />
		<result column="price_avg" property="priceAvg" />
		<result column="area_avg" property="areaAvg" />
	</resultMap>
	
	<!-- column과 변수명 맞추기 위한 resultMap -->
	<resultMap type="dongDto" id="dongDtoMap">
		<result column="dong_code" property="dongCode" />
		<result column="name" property="name" />
		<result column="sido_code" property="sidoCode" />
		<result column="sigungu_code" property="sigunguCode" />
	</resultMap>

	<!-- 검색에 따른 거래정보 출력 -->
	<select id="houseSearch" parameterType="houseSearchConditionDto"
		resultMap="houseDBDto">
		SELECT *
		FROM house_deal LEFT JOIN house_info USING (apt_code)
		WHERE dong_code = #{dongCode}
		<if test="year != null and year != 0">
          AND year = #{year}
      	</if> 
      	<if test="month != null and month != 0">
          AND month = #{month}
      	</if>
      	<if test="minPrice != null and minPrice != 0">
          AND price >= #{minPrice}
      	</if>
      	<if test="maxPrice != null and maxPrice != 0">
      	  AND price <![CDATA[ <= ]]> #{maxPrice}
      	</if>
      	<if test="minFloor != null and minFloor != 0">
          AND floor >= #{minFloor}
      	</if>
      	<if test="maxFloor != null and maxFloor != 0">
          AND floor <![CDATA[ <= ]]> #{maxFloor}
      	</if>
      	<if test="minArea != null and minArea != 0">
          AND area >= #{minArea}
      	</if>
      	<if test="maxArea != null and maxArea != 0">
          AND area <![CDATA[ <= ]]> #{maxArea}
      	</if> 
	</select>

	<!-- 관심 아파트 출력(house_code) -->
	<select id="houseLikes" parameterType="String"
		resultType="String">
		SELECT apt_code
		FROM favorite_house
		WHERE email = #{email};
	</select>

	<!-- 관심 거래 출력(deal_code) -->
	<select id="dealLikes" parameterType="String"
		resultMap="likeDto">
		SELECT deal_code, apt_code
		FROM favorite_deal
		WHERE email = #{email};
	</select>

	<select id="getSido" resultType="sidoDto">
		SELECT sido_code sidoCode, name
		FROM sido;
	</select>

	<select id="getSigungu" parameterType="String" resultType="sigunguDto">
		SELECT sido_code sidoCode, sigungu_code sigunguCode, name
		FROM sigungu
		WHERE sido_code = #{sido};
	</select>

	<select id="getDong" parameterType="String" resultMap="dongDtoMap">
		SELECT dong_code, sigungu_code, name, sido_code
		FROM dong
		WHERE sigungu_code = #{sigungu};
	</select>

	<insert id="houseLike" parameterType="Map">
		INSERT INTO favorite_house (email, apt_code, created_at)
		VALUES (#{userEmail}, #{aptCode}, NOW())
	</insert>

	<insert id="dealLike" parameterType="Map">
		INSERT INTO favorite_deal (email, deal_code, apt_code, created_at)
		VALUES (#{userEmail}, #{dealCode},
			(SELECT apt_code FROM house_deal WHERE deal_code = #{dealCode}), now());
	</insert>

	<delete id="houseDislike" parameterType="Map">
		DELETE FROM favorite_house
		WHERE email=#{userEmail} AND apt_code=#{aptCode}
	</delete>

	<delete id="dealDislike" parameterType="Map">
		DELETE FROM favorite_deal
		WHERE email=#{userEmail} AND deal_code=#{dealCode}
	</delete>

</mapper>